<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>ii.nz</title>
   <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Yeseva+One&family=Noto+Sans">
   <link rel="stylesheet" href='/css/normalize.css' type="text/css"/>
   <link rel="stylesheet" href='/css/variables.css' type="text/css"/>
   <link rel="stylesheet" href='/css/main.css' type="text/css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,500&display=swap" rel="stylesheet">
   <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  </style>
</head>
<body>
        <body onload="checkDarkMode()">
    <header>
      <nav class="navbar" role="navigation">
        <div class="navbar__left">
          <a href="/" class="nav-logo">
            <img src="/assets/nav-logo.png" id="navLogo" alt="Logo">
          </a>
        </div>
        <div class="navbar__right" id="navbarRight">
          <li>   
            <div class="icon" onclick="toggleIcon()">
              <i class="fas fa-moon" id="toggleMode"></i>
            </div>
          </li>
          <a href="/team">Team</a>
          <a href="/projects">Projects</a>
          <a href="/post">Blog</a>
          <a href="/contact">Contact</a>
        </div>
      </nav>
    </header>
  
    <script>
      function checkDarkMode() {
        var storedMode = localStorage.getItem('darkMode');
        if (storedMode === 'enabled') {
          applyDarkMode();
        }
      }
  
      function toggleIcon() {
        var iconElement = document.getElementById('toggleMode');
     
        if (iconElement.classList.contains('fa-moon')) {
          applyDarkMode();
          localStorage.setItem('darkMode', 'enabled');
        } else {
          removeDarkMode();
          localStorage.setItem('darkMode', 'disabled');
        }
      }
  
      function applyDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');


        iconElement.classList.remove('fa-moon');
        iconElement.classList.add('fa-sun');
        bg.classList.add('bg-dark');
        header.classList.add('header-dark');
        navbarRight.classList.add("navbar__right--dark");
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = 'white';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.add('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.add('modal-dark');
        }
        logoImage.src = `\/assets\/dark-mode-logo.png`;
      }
  
      function removeDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');

        
        iconElement.classList.remove('fa-sun');
        iconElement.classList.add('fa-moon');
        bg.classList.remove('bg-dark');
        header.classList.remove('header-dark');
        navbarRight.classList.remove("navbar__right--dark");
        logoImage.src = `\/assets\/nav-logo.png`;
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = '';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.remove('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.remove('modal-dark');
        }

      }
    </script>
  </body>
  
        <main id="content">
<section class="post__entry">
  <article>
    <h1 class="post__title">Creating an e2e test for Conformance</h1>
    <div class="post__info">
      <p>By
        
        <span class='post__author'>
          Stephen Heywood
        </span>
        
        ,
        <time>May 11, 2021</time>
      </p>
    </div>
    </div>
    <div class="post__content">
      
<h3 id="introduction">
  Introduction
  <a class = 'heading-anchor' href="#introduction">#</a>
</h3>
<p>Since the 1.19 release of Kubernetes, the gap in e2e conformance tested endpoints has decreased due in part to the processes and tooling that the team at <a href="https://ii.coop/">ii.coop</a> have developed.</p>
<figure class='oversized offcenter'>
<img src="/images/2021/apisnoop-progress.png" />
</figure>
<p>The process starts by using <a href="https://github.com/cncf/apisnoop">APIsnoop</a> (which uses a postgres database containing audit logs from e2e test runs) to identify a set of untested endpoints that are part of the stable API endpoints. During this process various groups or patterns of endpoints are discovered. One such group of endpoints are “DaemonSetStatus”. Next we will explore these endpoints, create an e2e test that exercises each of them, then merge this test into the k8s repo.</p>
<p>APIsnoop results for untested “DaemonSetStatus” endpoints in <a href="https://github.com/cncf/apisnoop/blob/main/apps/snoopdb/tables-views-functions.org#untested_stable_endpoints">untested_stable_endpoints table</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">select</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>endpoint,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>path,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>kind<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">from</span><span style="color:#bbb"> </span>testing.untested_stable_endpoint<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">where</span><span style="color:#bbb"> </span>eligible<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">is</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">and</span><span style="color:#bbb"> </span>endpoint<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ilike</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#39;%DaemonSetStatus&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">order</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">by</span><span style="color:#bbb"> </span>kind,<span style="color:#bbb"> </span>endpoint<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">desc</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                endpoint                  |                           path                                |    kind
</span></span><span style="display:flex;"><span>------------------------------------------+---------------------------------------------------------------+------------
</span></span><span style="display:flex;"><span>   replaceAppsV1NamespacedDaemonSetStatus | /apis/apps/v1/namespaces/{namespace}/daemonsets/{name}/status | DaemonSet
</span></span><span style="display:flex;"><span>   readAppsV1NamespacedDaemonSetStatus    | /apis/apps/v1/namespaces/{namespace}/daemonsets/{name}/status | DaemonSet
</span></span><span style="display:flex;"><span>   patchAppsV1NamespacedDaemonSetStatus   | /apis/apps/v1/namespaces/{namespace}/daemonsets/{name}/status | DaemonSet
</span></span><span style="display:flex;"><span>  (3 rows)
</span></span></code></pre></div>
<h2 id="connecting-an-endpoint-to-a-resource">
  Connecting an endpoint to a resource
  <a class = 'heading-anchor' href="#connecting-an-endpoint-to-a-resource">#</a>
</h2>
<p>Here are three possible ways use to connect an API endpoint to a resource in a cluster</p>
<ol>
<li>
<p>Some initial details about the endpoint can be found via the <a href="https://kubernetes.io/docs/reference/kubernetes-api/">API Reference</a>. For this example about Daemonset we can locate <a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#get-read-status-of-the-specified-daemonset">read</a>, <a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#patch-partially-update-status-of-the-specified-daemonset">patch</a> and <a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#update-replace-status-of-the-specified-daemonset">replace</a> for Daemonset Status.</p>
</li>
<li>
<p><code>kubectl</code> has an option to describe the fields associated with each supported API resource. The following example shows how it can provide details around ’status conditions’.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>   $ kubectl explain daemonset.status.conditions
</span></span><span style="display:flex;"><span>   KIND:     DaemonSet
</span></span><span style="display:flex;"><span>   VERSION:  apps/v1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   RESOURCE: conditions &lt;[]Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   DESCRIPTION:
</span></span><span style="display:flex;"><span>        Represents the latest available observations of a DaemonSet&#39;s current
</span></span><span style="display:flex;"><span>        state.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        DaemonSetCondition describes the state of a DaemonSet at a certain point.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   FIELDS:
</span></span><span style="display:flex;"><span>      lastTransitionTime   &lt;string&gt;
</span></span><span style="display:flex;"><span>        Last time the condition transitioned from one status to another.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      message      &lt;string&gt;
</span></span><span style="display:flex;"><span>        A human readable message indicating details about the transition.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      reason       &lt;string&gt;
</span></span><span style="display:flex;"><span>        The reason for the condition&#39;s last transition.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      status       &lt;string&gt; -required-
</span></span><span style="display:flex;"><span>        Status of the condition, one of True, False, Unknown.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      type &lt;string&gt; -required-
</span></span><span style="display:flex;"><span>        Type of DaemonSet condition.
</span></span></code></pre></div></li>
<li>
<p>Lastly, using both <a href="https://github.com/cncf/apisnoop/tree/main/kind">APIsnoop in cluster</a> while reviewing the current <a href="https://github.com/kubernetes/kubernetes/tree/master/test/e2e">e2e test suite</a> for existing conformance tests that test a similar set of endpoints. In this case we used <a href="https://github.com/kubernetes/kubernetes/blob/7b2776b89fb1be28d4e9203bdeec079be903c103/test/e2e/network/service.go#L2300-L2392">a Service Status test</a> as a template for the new Daemonset test.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">with</span><span style="color:#bbb"> </span>latest_release<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">as</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">select</span><span style="color:#bbb"> </span>release::semver<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">as</span><span style="color:#bbb"> </span>release<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">from</span><span style="color:#bbb"> </span>open_api<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">order</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">by</span><span style="color:#bbb"> </span>release::semver<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">desc</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">limit</span><span style="color:#bbb"> </span><span style="color:#40a070">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">select</span><span style="color:#bbb"> </span>ec.endpoint,<span style="color:#bbb"> </span>ec.path,<span style="color:#bbb"> </span>ec.kind<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">from</span><span style="color:#bbb"> </span>endpoint_coverage<span style="color:#bbb">  </span>ec<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">join</span><span style="color:#bbb"> </span>latest_release<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">on</span>(ec.release::semver<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>latest_release.release)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">where</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">level</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#39;stable&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">and</span><span style="color:#bbb"> </span>ec.endpoint<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ilike</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#39;%NamespacedServiceStatus&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">and</span><span style="color:#bbb"> </span>tested<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">is</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">ORDER</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">BY</span><span style="color:#bbb"> </span>endpoint<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">desc</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                  endpoint               |                         path                          |  kind
</span></span><span style="display:flex;"><span>   --------------------------------------+-------------------------------------------------------+---------
</span></span><span style="display:flex;"><span>    replaceCoreV1NamespacedServiceStatus | /api/v1/namespaces/{namespace}/services/{name}/status | Service
</span></span><span style="display:flex;"><span>    readCoreV1NamespacedServiceStatus    | /api/v1/namespaces/{namespace}/services/{name}/status | Service
</span></span><span style="display:flex;"><span>    patchCoreV1NamespacedServiceStatus   | /api/v1/namespaces/{namespace}/services/{name}/status | Service
</span></span><span style="display:flex;"><span>   (3 rows)
</span></span></code></pre></div><p>The Service status e2e test followed similar ideas and patterns from <a href="https://github.com/kubernetes/kubernetes/blob/31030820be979ea0b2c39e08eb18fddd71f353ed/test/e2e/auth/certificates.go#L356-L383">/test/e2e/auth/certificates.go</a> and <a href="https://github.com/kubernetes/kubernetes/blob/31030820be979ea0b2c39e08eb18fddd71f353ed/test/e2e/network/ingress.go#L1091-L1127">/test/e2e/network/ingress.go</a></p>
</li>
</ol>

<h2 id="writing-an-e2e-test">
  Writing an e2e test
  <a class = 'heading-anchor' href="#writing-an-e2e-test">#</a>
</h2>

<h3 id="initial-exploration">
  Initial Exploration
  <a class = 'heading-anchor' href="#initial-exploration">#</a>
</h3>
<p>Using <a href="https://wiki.c2.com/?LiterateProgramming">literate programming</a> we created <a href="https://github.com/apisnoop/ticket-writing/blob/create-daemonset-status-lifecycle-test/Appsv1DaemonSetStatusLifecycleTest.org">Appsv1DaemonSetStatusLifecycleTest.org</a>
(via <a href="https://github.com/sharingio/pair">pair</a>) to both test and document the explorations of the endpoints. This provides a clear outline that should be easily replicated and validated by others as needed.
Once completed, the document is converted into markdown which becomes a GitHub <a href="https://github.com/kubernetes/kubernetes/issues/100437">issue</a>.</p>
<p>The issue provides the following before a PR is opened:</p>
<ul>
<li>a starting point to discuss the endpoints</li>
<li>the approach taken to test them</li>
<li>whether they are <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/conformance-tests.md#conformance-test-requirements">eligible for conformance</a>.</li>
</ul>

<h3 id="creating-the-e2e-test">
  Creating the e2e test
  <a class = 'heading-anchor' href="#creating-the-e2e-test">#</a>
</h3>
<p>Utilizing the above document, the test is structured in to four parts;</p>
<ol>
<li>
<p>Creating the resources for the test, in this case a DaemonSet and a ’watch’.</p>
</li>
<li>
<p>Testing the first endpoint, <code>readAppsV1NamespacedReplicaSetStatus</code> via a <a href="https://github.com/ii/kubernetes/blob/ca3aa6f5af1b545b116b52c717b866e43c79079b/test/e2e/apps/daemon_set.go#L841">dynamic client</a>. This is due to the standard go client not being able to access the sub-resource. We also make sure there are no errors from either getting or decoding the response.</p>
</li>
<li>
<p>The next endpoint tested is <code>replaceAppsV1NamespacedDaemonSetStatus</code> which replaces all status conditions at the same time. As the resource version of the DaemonSet may change before the new status conditions are updated we may need to <a href="https://github.com/ii/kubernetes/blob/ca3aa6f5af1b545b116b52c717b866e43c79079b/test/e2e/apps/daemon_set.go#L854">retry the request if there is a conflict</a>. Monitoring the watch events for the Daemonset we can confirm that the status conditions have been <a href="https://github.com/ii/kubernetes/blob/ca3aa6f5af1b545b116b52c717b866e43c79079b/test/e2e/apps/daemon_set.go#L884-L886">replaced</a>.</p>
</li>
<li>
<p>The last endpoint tested is <code>patchAppsV1NamespacedReplicaSetStatus</code> which only patches a <a href="https://github.com/ii/kubernetes/blob/ca3aa6f5af1b545b116b52c717b866e43c79079b/test/e2e/apps/daemon_set.go#L906">single condition</a> this time. Again, using the watch to monitor for events we can check that the single condition <a href="https://github.com/ii/kubernetes/blob/ca3aa6f5af1b545b116b52c717b866e43c79079b/test/e2e/apps/daemon_set.go#L931">has been updated</a>.</p>
</li>
</ol>

<h3 id="validating-the-e2e-test">
  Validating the e2e test
  <a class = 'heading-anchor' href="#validating-the-e2e-test">#</a>
</h3>
<p>Using <code>go test</code> we can run a single test for quick feedback</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#007020">cd</span> ~/go/src/k8s.io/kubernetes
</span></span><span style="display:flex;"><span><span style="color:#bb60d5">TEST_NAME</span><span style="color:#666">=</span><span style="color:#4070a0">&#34;should verify changes to a daemon set status&#34;</span>
</span></span><span style="display:flex;"><span>go <span style="color:#007020">test</span> ./test/e2e/ -v -timeout<span style="color:#666">=</span><span style="color:#40a070">0</span>  --report-dir<span style="color:#666">=</span>/tmp/ARTIFACTS -ginkgo.focus<span style="color:#666">=</span><span style="color:#4070a0">&#34;</span><span style="color:#bb60d5">$TEST_NAME</span><span style="color:#4070a0">&#34;</span>
</span></span></code></pre></div><p>Checking the e2e test logs we see that everything looks to be okay.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[It] should verify changes to a daemon set status  /home/ii/go/src/k8s.io/kubernetes/test/e2e/apps/daemon_set.go:812
</span></span><span style="display:flex;"><span>STEP: Creating simple DaemonSet &#34;daemon-set&#34;
</span></span><span style="display:flex;"><span>STEP: Check that daemon pods launch on every node of the cluster.
</span></span><span style="display:flex;"><span>May 10 17:36:36.106: INFO: Number of nodes with available pods: 0
</span></span><span style="display:flex;"><span>May 10 17:36:36.106: INFO: Node heyste-control-plane-fkjmr is running more than one daemon pod
</span></span><span style="display:flex;"><span>May 10 17:36:37.123: INFO: Number of nodes with available pods: 0
</span></span><span style="display:flex;"><span>May 10 17:36:37.123: INFO: Node heyste-control-plane-fkjmr is running more than one daemon pod
</span></span><span style="display:flex;"><span>May 10 17:36:38.129: INFO: Number of nodes with available pods: 0
</span></span><span style="display:flex;"><span>May 10 17:36:38.129: INFO: Node heyste-control-plane-fkjmr is running more than one daemon pod
</span></span><span style="display:flex;"><span>May 10 17:36:39.122: INFO: Number of nodes with available pods: 1
</span></span><span style="display:flex;"><span>May 10 17:36:39.122: INFO: Number of running nodes: 1, number of available pods: 1
</span></span><span style="display:flex;"><span>STEP: Getting /status
</span></span><span style="display:flex;"><span>May 10 17:36:39.142: INFO: Daemon Set daemon-set has Conditions: []
</span></span><span style="display:flex;"><span>STEP: updating the DaemonSet Status
</span></span><span style="display:flex;"><span>May 10 17:36:39.160: INFO: updatedStatus.Conditions: []v1.DaemonSetCondition{v1.DaemonSetCondition{Type:&#34;StatusUpdate&#34;, Status:&#34;True&#34;, LastTransitionTime:v1.Time{Time:time.Ti
</span></span><span style="display:flex;"><span>me{wall:0x0, ext:0, loc:(*time.Location)(nil)}}, Reason:&#34;E2E&#34;, Message:&#34;Set from e2e test&#34;}}
</span></span><span style="display:flex;"><span>STEP: watching for the daemon set status to be updated
</span></span><span style="display:flex;"><span>May 10 17:36:39.163: INFO: Observed event: ADDED
</span></span><span style="display:flex;"><span>May 10 17:36:39.163: INFO: Observed event: MODIFIED
</span></span><span style="display:flex;"><span>May 10 17:36:39.163: INFO: Observed event: MODIFIED
</span></span><span style="display:flex;"><span>May 10 17:36:39.164: INFO: Observed event: MODIFIED
</span></span><span style="display:flex;"><span>May 10 17:36:39.164: INFO: Found daemon set daemon-set in namespace daemonsets-2986 with labels: map[daemonset-name:daemon-set] annotations: map[deprecated.daemonset.template
</span></span><span style="display:flex;"><span>.generation:1] &amp; Conditions: [{StatusUpdate True 0001-01-01 00:00:00 +0000 UTC E2E Set from e2e test}]
</span></span><span style="display:flex;"><span>May 10 17:36:39.164: INFO: Daemon set daemon-set has an updated status
</span></span><span style="display:flex;"><span>STEP: patching the DaemonSet Status
</span></span><span style="display:flex;"><span>STEP: watching for the daemon set status to be patched
</span></span><span style="display:flex;"><span>May 10 17:36:39.180: INFO: Observed event: ADDED
</span></span><span style="display:flex;"><span>May 10 17:36:39.180: INFO: Observed event: MODIFIED
</span></span><span style="display:flex;"><span>May 10 17:36:39.181: INFO: Observed event: MODIFIED
</span></span><span style="display:flex;"><span>May 10 17:36:39.181: INFO: Observed event: MODIFIED
</span></span><span style="display:flex;"><span>May 10 17:36:39.181: INFO: Observed daemon set daemon-set in namespace daemonsets-2986 with annotations: map[deprecated.daemonset.template.generation:1] &amp; Conditions: [{StatusUpdate True 0001-01-01 00:00:00 +0000 UTC E2E Set from e2e test}]
</span></span><span style="display:flex;"><span>May 10 17:36:39.181: INFO: Found daemon set daemon-set in namespace daemonsets-2986 with labels: map[daemonset-name:daemon-set] annotations: map[deprecated.daemonset.template.generation:1] &amp; Conditions: [{StatusPatched True 0001-01-01 00:00:00 +0000 UTC  }]
</span></span><span style="display:flex;"><span>May 10 17:36:39.181: INFO: Daemon set daemon-set has a patched status
</span></span></code></pre></div><p>Verification that the test passed!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Ran 1 of 5745 Specs in 18.473 seconds
</span></span><span style="display:flex;"><span>SUCCESS! -- 1 Passed | 0 Failed | 0 Pending | 5744 Skipped
</span></span><span style="display:flex;"><span>--- PASS: TestE2E (18.62s)
</span></span></code></pre></div><p>Using APISnoop with the audit logger we can also confirm that the endpoints where hit during the test.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">select</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">distinct</span><span style="color:#bbb">  </span>endpoint,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">right</span>(useragent,<span style="color:#40a070">75</span>)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">AS</span><span style="color:#bbb"> </span>useragent<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">from</span><span style="color:#bbb"> </span>testing.audit_event<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">where</span><span style="color:#bbb"> </span>endpoint<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">ilike</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#39;%DaemonSetStatus%&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">and</span><span style="color:#bbb"> </span>release_date::<span style="color:#007020">BIGINT</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>round(((<span style="color:#007020;font-weight:bold">EXTRACT</span>(EPOCH<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">FROM</span><span style="color:#bbb"> </span>NOW()))::<span style="color:#007020">numeric</span>)<span style="color:#666">*</span><span style="color:#40a070">1000</span>,<span style="color:#40a070">0</span>)<span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#40a070">60000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">and</span><span style="color:#bbb"> </span>useragent<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">like</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#39;e2e%&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">order</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">by</span><span style="color:#bbb"> </span>endpoint;<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                endpoint                 |                             useragent
</span></span><span style="display:flex;"><span>-----------------------------------------+-------------------------------------------------------------------
</span></span><span style="display:flex;"><span> patchAppsV1NamespacedReplicaSetStatus   | [sig-apps] ReplicaSet should validate Replicaset Status endpoints
</span></span><span style="display:flex;"><span> readAppsV1NamespacedReplicaSetStatus    | [sig-apps] ReplicaSet should validate Replicaset Status endpoints
</span></span><span style="display:flex;"><span> replaceAppsV1NamespacedReplicaSetStatus | [sig-apps] ReplicaSet should validate Replicaset Status endpoints
</span></span><span style="display:flex;"><span>(3 rows)
</span></span></code></pre></div><p>Even though the test has passed here, once merged it will join other jobs on <a href="https://testgrid.k8s.io/">TestGrid</a> to determine if the test is stable and after two weeks it can be <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/conformance-tests.md#promoting-tests-to-conformance">promoted to conformance</a>.</p>

<h2 id="final-thoughts">
  Final Thoughts
  <a class = 'heading-anchor' href="#final-thoughts">#</a>
</h2>
<p>The current workflow and tooling provides a high level of confidence when working through each e2e test. Following agreed coding patterns, styles and processes helps to minimise possible issues and test flakes. There’s always opportunities to get support through GitHub tickets, <a href="https://kubernetes.slack.com/messages/k8s-conformance">various Kubernetes slack channels</a> and conformance meetings.</p>
<p>Every e2e test that’s merged and then promoted to conformance requires the input from a wide range of people. It is thanks to the support from community reviewers, SIGs and the direction provided by SIG-Architecture this work is not just possible but rewarding.</p>

    </div>
  </article>
  <nav class="back-nav">
  <a href="/post">← back to posts</a>
  </nav>
</section>

        </main>
        
<footer>
  <div class="footer__left">
  <b class='footer_logo'><a href="/">ii</a></b>
  </div>
  <div class='footer__right'>
  <ul class="contact-details">
 
    <li>   
      <a href="https://github.com/ii">
        <div id="github" class="icon">
            <i class="fab fa-github"></i>
        </div>
        Github
      </a>
    </li>
    <li>
      <a href="https://gitlab.com/ii">
        <div class="icon">
          <i class="fab fa-gitlab"></i>
        </div>
        Gitlab
      </a>
    </li>
    <li>
      <a href="mailto:hello@ii.nz">
        <div class="icon">
          <i class="fas fa-envelope"></i>
      </div>
      Email
      </a>
    </li>
    <li>
      <a href="https://www.linkedin.com/company/99165471/" target="_blank" rel="noopener noreferrer">
        <div class="icon">
          <i class="fab fa-linkedin"></i>
        </div>
        LinkedIn
      </a>
    </li>
    
  </ul>
</footer>
    </body>
</html>