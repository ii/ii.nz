<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>ii.nz</title>
   <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Yeseva+One&family=Noto+Sans">
   <link rel="stylesheet" href='/css/normalize.css' type="text/css"/>
   <link rel="stylesheet" href='/css/variables.css' type="text/css"/>
   <link rel="stylesheet" href='/css/main.css' type="text/css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,500&display=swap" rel="stylesheet">
   <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  </style>
</head>
<body>
        <body onload="checkDarkMode()">
    <header>
      <nav class="navbar" role="navigation">
        <div class="navbar__left">
          <a href="/" class="nav-logo">
            <img src="/assets/nav-logo.png" id="navLogo" alt="Logo">
          </a>
        </div>
        <div class="navbar__right" id="navbarRight">
          <li>   
            <div class="icon" onclick="toggleIcon()">
              <i class="fas fa-moon" id="toggleMode"></i>
            </div>
          </li>
          <a href="/team">Team</a>
          <a href="/projects">Projects</a>
          <a href="/post">Blog</a>
          <a href="/contact">Contact</a>
        </div>
      </nav>
    </header>
  
    <script>
      function checkDarkMode() {
        var storedMode = localStorage.getItem('darkMode');
        if (storedMode === 'enabled') {
          applyDarkMode();
        }
      }
  
      function toggleIcon() {
        var iconElement = document.getElementById('toggleMode');
     
        if (iconElement.classList.contains('fa-moon')) {
          applyDarkMode();
          localStorage.setItem('darkMode', 'enabled');
        } else {
          removeDarkMode();
          localStorage.setItem('darkMode', 'disabled');
        }
      }
  
      function applyDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');


        iconElement.classList.remove('fa-moon');
        iconElement.classList.add('fa-sun');
        bg.classList.add('bg-dark');
        header.classList.add('header-dark');
        navbarRight.classList.add("navbar__right--dark");
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = 'white';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.add('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.add('modal-dark');
        }
        logoImage.src = `\/assets\/dark-mode-logo.png`;
      }
  
      function removeDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');

        
        iconElement.classList.remove('fa-sun');
        iconElement.classList.add('fa-moon');
        bg.classList.remove('bg-dark');
        header.classList.remove('header-dark');
        navbarRight.classList.remove("navbar__right--dark");
        logoImage.src = `\/assets\/nav-logo.png`;
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = '';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.remove('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.remove('modal-dark');
        }

      }
    </script>
  </body>
  
        <main id="content">
<section class="post__entry">
  <article>
    <h1 class="post__title">Kubernetes conformance updates for October 2022</h1>
    <div class="post__info">
      <p>By
        
        <span class='post__author'>
          Caleb Woodbine
        </span>
        
        <span class='post__author'>
          Riaan Kleinhans
        </span>
        
        <span class='post__author'>
          Stephen Heywood
        </span>
        
        ,
        <time>October 19, 2022</time>
      </p>
    </div>
    </div>
    <div class="post__content">
      <blockquote>
<p>Cross-posted from <a href="https://www.cncf.io/blog/2022/10/19/kubernetes-conformance-updates-for-october-2022/">https://www.cncf.io/blog/2022/10/19/kubernetes-conformance-updates-for-october-2022/</a></p>
</blockquote>

<h2 id="introduction">
  Introduction
  <a class = 'heading-anchor' href="#introduction">#</a>
</h2>
<p>The Kubernetes Conformance project has been running for a number of years now, recently there are a few minor updates to it and a few things to celebrate.</p>

<h2 id="coverage">
  Coverage
  <a class = 'heading-anchor' href="#coverage">#</a>
</h2>
<p>Looking back at the history of Kubernetes Conformance we need to go back to February 2018 when <a href="https://github.com/oomichi">Kenichi Omichi</a> dug into the Kubernetes logs and found that Kubernetes had 481 API endpoints, only 53 endpoints, or 11% were covered by tests. Dan Kohn knew that for the <a href="https://github.com/cncf/k8s-conformance/pulls#certified-kubernetes">Certified Kubernetes brand</a> to have meaning, they needed to invest to make sure test coverage was much higher.</p>
<p>To address the gap in conformance testing Kubernetes Conformance subproject was established and met for the first time on <a href="https://www.youtube.com/watch?v=uqA1JtRtLXs&amp;list=PL69nYSiGNLP2m6198LaLN6YahX7EEac5g&amp;index=192">26 March 2019</a>. The aim for the subproject was to accelerate work on improving conformance test coverage, perform conformance test reviews, develop processes to support the work, prioritize work and discuss test criteria.</p>
<p>The diligent work of test writers and reviewers has paid off, with less than 6% of the endpoints not covered by Conformance tests when 1.25 was released. Also, in that release we finally have 100% coverage for all app endpoints.</p>
<p>Not only was it important to ensure that existing technical debt is being paid off through the delivery of quality conformance tests, but also ensuring that no new technical debt is created through API endpoints graduating to GA without Conformance tests. This is achieved through weekly updates of <a href="https://apisnoop.cncf.io">APISnoop</a> and careful monitoring of the results.</p>

<h2 id="community-operations">
  Community Operations
  <a class = 'heading-anchor' href="#community-operations">#</a>
</h2>
<p>Automation is a fundamental value of the Kubernetes community.
For each release, Kubernetes product and distribution owners submit a PR to the k8s-conformance repo in order to certify their product or distribution.</p>
<p>Since around the time of the release of Kubernetes v1.18, a bot was built by Berno Kleinhans and Rob Kielty to automate the checking of the PRs in this repo.
In order to verify conformance, the Kubernetes e2e conformance suite must be run against a cluster.</p>
<p>This is where <a href="https://github.com/vmware-tanzu/sonobuoy">sonobuoy</a>, a community tool from <a href="https://tanzu.vmware.com/">vmware-tanzu</a> for generating conformance test run data, comes in. When sonobuoy is run, it runs the test suite against a target cluster. Once the suite is complete the e2e.log and junit_01.xml can be collected. These files describe what was run and how it ran.</p>
<p>Each PR has the four following files</p>
<ul>
<li>a PRODUCT.yaml; to provide metadata on the product</li>
<li>an e2e.log: to store the test runner’s logs</li>
<li>a junit_01.xml: to store a structured list of the tests that were run; and finally</li>
<li>a README.md: to provide instructions on how the submitter created the cluster and generated results</li>
</ul>

<h2 id="test-definitions">
  Test definitions
  <a class = 'heading-anchor' href="#test-definitions">#</a>
</h2>
<p>I was tasked with the rewrite of the bot. In this rewrite, the behaviour of the bot has been greatly improved as well as the tests made easier to understand.
<a href="https://cucumber.io/docs/gherkin/">Gherkin</a> is a way to plainly describe features for specifications and implement the code separately. Much earlier before Gherkin was implemented in the Kubernetes conformance bot, Zach Mandeville (also from <a href="https://ii.nz">ii.nz</a>) had implemented Gherkin in the <a href="https://github.com/ii/xds-test-harness">XDS test suite</a> through <a href="https://github.com/cucumber/godog">godog</a>. With this inspiration and a keener focus on understandability and maintainability, Gherkin was naturally chosen.</p>
<p>Here is a snippet from the bot’s feature file, to provide very high-level language instructions for the tests for the submissions through the bot:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-feature" data-lang="feature"><span style="display:flex;"><span><span style="color:#06287e">  </span><span style="color:#007020;font-weight:bold">Scenario:</span><span style="color:#06287e"> all tests pass in e2e.log
</span></span></span><span style="display:flex;"><span><span style="color:#06287e">    it appears that some tests failed in the product submission
</span></span></span><span style="display:flex;"><span><span style="color:#06287e"></span><span style="color:#007020;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">    Given </span><span style="color:#06287e">an &#34;</span><span style="color:#4070a0">e2e.log</span><span style="color:#06287e">&#34; file
</span></span></span><span style="display:flex;"><span><span style="color:#06287e">    </span><span style="color:#007020;font-weight:bold">Then </span><span style="color:#06287e">the tests pass and are successful
</span></span></span><span style="display:flex;"><span><span style="color:#06287e">    </span><span style="color:#007020;font-weight:bold">And </span><span style="color:#06287e">all required tests in e</span><span style="color:#4070a0">2</span><span style="color:#06287e">e.log are present
</span></span></span></code></pre></div><p>The scenario above regards that the expected state of all tests pass in the submitted e2e.log file. The second line is the failure message.
The test begins with ensuring that the file e2e.log exists in the PR, it states in an intended way for the outcome that all tests are passing and are successful, finally that all required tests are present.
In Gherkin, there are directives like “Given”, “Then” and “And”. These directives begin declaring lines of the test. After each directive, there’s a statement like “the tests pass and are successful”; Each statement maps to some function in code through an implementation of the feature file, in this case Go functions with Godog.
For instance, the line “Given an “e2e.log” file” matches to a handling function through this regex here</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>ctx.<span style="color:#06287e">Step</span>(<span style="color:#4070a0">`^a[n]? &#34;([^&#34;]*)&#34; file$`</span>, s.aFile)
</span></span></code></pre></div><p>then the function that handles the test, checking for a file’s existence</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> (s <span style="color:#666">*</span>PRSuite) <span style="color:#06287e">aFile</span>(fileName <span style="color:#902000">string</span>) <span style="color:#902000">error</span> {
</span></span><span style="display:flex;"><span>	file <span style="color:#666">:=</span> s.<span style="color:#06287e">GetFileByFileName</span>(fileName)
</span></span><span style="display:flex;"><span>	<span style="color:#007020;font-weight:bold">if</span> file <span style="color:#666">==</span> <span style="color:#007020;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#007020;font-weight:bold">return</span> common.<span style="color:#06287e">SafeError</span>(fmt.<span style="color:#06287e">Errorf</span>(<span style="color:#4070a0">&#34;missing required file &#39;%v&#39;&#34;</span>, fileName))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can find out more about Gherkin, <a href="https://cucumber.io/docs/gherkin/">here</a> and Godog (the Go implementation) <a href="https://github.com/cucumber/godog">here</a>.</p>
<p>There are currently 15 scenarios, covering requirements like</p>
<ul>
<li>required tests present and passing</li>
<li>title format</li>
<li>folder structure</li>
<li>file presence</li>
<li>values in PRODUCT.yaml</li>
<li>URL resolution for URLs in PRODUCT.yaml</li>
<li>amount of commits</li>
</ul>
<p>and many more.</p>

<h2 id="behaviour">
  Behaviour
  <a class = 'heading-anchor' href="#behaviour">#</a>
</h2>
<p>The bot will now respond with a single message after each difference on a commit, as well as updating the labels on the PR. Under-the-hood, the bot is now declarative.
Additionally, the bot also updates the status checks at the end of bottom of the PR page.
A successful product submission will result in the following message,</p>
<figure>
<img alt='Screenshot shwoing prow-cncf-io comment' src='/images/2021/k8s-conformance-oct21-checks-passing.png' />
</figure>
<p>the following checks passing,</p>
<figure>
<img alt='Screenshot showing checks passing' src='/images/2021/k8s-conformance-oct21-gh-status-checks.png' />
</figure>
<p>and the similar labels</p>
<figure>
<img alt='Screenshot showing labels' src='/images/2021/k8s-conformance-oct21-gh-labels.png' />
</figure>
<p>A failing product submission result in a comment something like this,</p>
<figure>
<img alt='Screenshot showing prow-cncf-io commented 13 of 15 requirements have passed, 2 fails items need to be reviewed' src='/images/2021/k8s-conformance-oct21-checks-failing.png' />
</figure>
<p>the following status checks failing</p>
<figure>
<img alt='Screenshot showing some checks were not successful (1 filing and 1 pending checks)' src='/images/2021/k8s-conformance-oct21-gh-status-checks-failing.png' />
</figure>
<p>and labels similar to this</p>
<figure>
<img alt='Screenshot showing labels' src='/images/2021/k8s-conformance-oct21-gh-labels-failing.png' />
</figure>
<p>These changes have been shown to be incredibly helpful for product submitters, easing the process of submitting and determining potential issues.</p>

<h2 id="closing">
  Closing
  <a class = 'heading-anchor' href="#closing">#</a>
</h2>
<p>Overall, the Kubernetes conformance has come along way in the past four years.
The project has almost reached completion and has received some smoother automations and feedback.</p>
<p>You can find out more about the project here</p>
<ul>
<li>apisnoop: <a href="https://apisnoop.cncf.io">https://apisnoop.cncf.io</a></li>
<li>k8s-conformance repo: <a href="https://github.com/cncf/k8s-conformance">https://github.com/cncf/k8s-conformance</a></li>
<li>verify-conformance bot repo: <a href="https://github.com/cncf-infra/verify-conformance">https://github.com/cncf-infra/verify-conformance</a></li>
</ul>

    </div>
  </article>
  <nav class="back-nav">
  <a href="/post">← back to posts</a>
  </nav>
</section>

        </main>
        
<footer>
  <div class="footer__left">
  <b class='footer_logo'><a href="/">ii</a></b>
  </div>
  <div class='footer__right'>
  <ul class="contact-details">
 
    <li>   
      <a href="https://github.com/ii">
        <div id="github" class="icon">
            <i class="fab fa-github"></i>
        </div>
        Github
      </a>
    </li>
    <li>
      <a href="https://gitlab.com/ii">
        <div class="icon">
          <i class="fab fa-gitlab"></i>
        </div>
        Gitlab
      </a>
    </li>
    <li>
      <a href="mailto:hello@ii.nz">
        <div class="icon">
          <i class="fas fa-envelope"></i>
      </div>
      Email
      </a>
    </li>
    <li>
      <a href="https://www.linkedin.com/company/99165471/" target="_blank" rel="noopener noreferrer">
        <div class="icon">
          <i class="fab fa-linkedin"></i>
        </div>
        LinkedIn
      </a>
    </li>
    
  </ul>
</footer>
    </body>
</html>