<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>ii.nz</title>
   <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Yeseva+One&family=Noto+Sans">
   <link rel="stylesheet" href='/css/normalize.css' type="text/css"/>
   <link rel="stylesheet" href='/css/variables.css' type="text/css"/>
   <link rel="stylesheet" href='/css/main.css' type="text/css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,500&display=swap" rel="stylesheet">
   <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  </style>
</head>
<body>
        <body onload="checkDarkMode()">
    <header>
      <nav class="navbar" role="navigation">
        <div class="navbar__left">
          <a href="/" class="nav-logo">
            <img src="/assets/nav-logo.png" id="navLogo" alt="Logo">
          </a>
        </div>
        <div class="navbar__right" id="navbarRight">
          <li>   
            <div class="icon" onclick="toggleIcon()">
              <i class="fas fa-moon" id="toggleMode"></i>
            </div>
          </li>
          <a href="/team">Team</a>
          <a href="/projects">Projects</a>
          <a href="/post">Blog</a>
          <a href="/contact">Contact</a>
        </div>
      </nav>
    </header>
  
    <script>
      
      function checkDarkMode() {
        var storedMode = localStorage.getItem('darkMode');
        if (storedMode === 'enabled') {
          applyDarkMode();
        }
      }
  
      function toggleIcon() {
        var iconElement = document.getElementById('toggleMode');
     
        
        if (iconElement.classList.contains('fa-moon')) {
          applyDarkMode();
          localStorage.setItem('darkMode', 'enabled');
        } else {
          removeDarkMode();
          localStorage.setItem('darkMode', 'disabled');
        }
      }
  
      
      function applyDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');


        iconElement.classList.remove('fa-moon');
        iconElement.classList.add('fa-sun');
        bg.classList.add('bg-dark');
        header.classList.add('header-dark');
        navbarRight.classList.add("navbar__right--dark");
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = 'white';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.add('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.add('modal-dark');
        }
        logoImage.src = "\/assets\/dark-mode-logo.png";
      }
  
      
      function removeDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');

        
        iconElement.classList.remove('fa-sun');
        iconElement.classList.add('fa-moon');
        bg.classList.remove('bg-dark');
        header.classList.remove('header-dark');
        navbarRight.classList.remove("navbar__right--dark");
        logoImage.src = "\/assets\/nav-logo.png";
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = '';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.remove('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.remove('modal-dark');
        }

      }
    </script>
  </body>
  
        <main id="content">
<section class="post__entry">
  <article>
    <h1 class="post__title">Rerouting Container Registries With Envoy</h1>
    <div class="post__info">
      <p>By
        
        <span class='post__author'>
          Caleb Woodbine
        </span>
        
        ,
        <time>April 15, 2021</time>
      </p>
    </div>
    </div>
    <div class="post__content">
      
<h3 id="introduction">
  Introduction
  <a class = 'heading-anchor' href="#introduction">#</a>
</h3>
<p>In this post, I will detail the discovery of Envoy&rsquo;s dynamic rewriting location capabilities and the relationship to OCI registries.</p>
<p><strong><strong>What is <a href="https://www.envoyproxy.io/">Envoy</a>?</strong></strong></p>
<blockquote>
<p>open source edge and service proxy, designed for cloud-native applications</p>
</blockquote>
<p><strong><strong>What is an <a href="https://opencontainers.org/">OCI container registry</a>?</strong></strong></p>
<blockquote>
<p>a standard, and specification, for the implementation of container registries</p>
</blockquote>
<p>I&rsquo;ve been playing around with and learning Envoy for a number of months now. One of the concepts I&rsquo;m investigating is rewriting the request&rsquo;s host.
Envoy is a super powerful piece of software. It is flexible and highly dynamic.</p>

<h3 id="journey">
  Journey
  <a class = 'heading-anchor' href="#journey">#</a>
</h3>

<h4 id="my-expectations">
  My expectations
  <a class = 'heading-anchor' href="#my-expectations">#</a>
</h4>
<p>The goal is to set up Envoy on a host to rewrite all requests dynamically back to a container registry hosted by a cloud-provider, such as GCP.</p>

<h4 id="initial-discoveries">
  Initial discoveries
  <a class = 'heading-anchor' href="#initial-discoveries">#</a>
</h4>
<p>One of the first things I investigated was the ability to get traffic from one site and serve it on another (proxying).
I searched in the docs and in their <a href="https://www.envoyproxy.io/docs/envoy/v1.17.1/start/quick-start/configuration-static">most basic example</a> could see that, by using envoy&rsquo;s http filter in the filter_chains, a static host could be rewritten.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#0e84b5;font-weight:bold">...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">static_resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">listeners</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>listener_0<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">address</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">socket_address</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">address</span>:<span style="color:#bbb"> </span><span style="color:#40a070">0.0.0.0</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">port_value</span>:<span style="color:#bbb"> </span><span style="color:#40a070">10000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">filter_chains</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#062873;font-weight:bold">filters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>envoy.filters.network.http_connection_manager<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">typed_config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">stat_prefix</span>:<span style="color:#bbb"> </span>ingress_http<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">access_log</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>envoy.access_loggers.file<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">typed_config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">path</span>:<span style="color:#bbb"> </span>/dev/stdout<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">http_filters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>envoy.filters.http.router<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">route_config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>local_route<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">virtual_hosts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>local_service<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">domains</span>:<span style="color:#bbb"> </span>[<span style="color:#4070a0">&#34;*&#34;</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">routes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- <span style="color:#062873;font-weight:bold">match</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                  </span><span style="color:#062873;font-weight:bold">prefix</span>:<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;/&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#062873;font-weight:bold">route</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                  </span><span style="color:#062873;font-weight:bold">host_rewrite_literal</span>:<span style="color:#bbb"> </span>www.envoyproxy.io<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                  </span><span style="color:#062873;font-weight:bold">cluster</span>:<span style="color:#bbb"> </span>service_envoyproxy_io<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">...</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>This is a great start! This serves the site and its content under the host where Envoy is served.
However, the host in the rewrite is static and not dynamic. It seems at this point like doing the implementation this way is not viable.</p>

<h4 id="learning-about-filter-chains">
  Learning about filter-chains
  <a class = 'heading-anchor' href="#learning-about-filter-chains">#</a>
</h4>
<p>Envoy has the lovely feature to set many kinds of middleware in the middle of a request.
This middleware can be used to add/change/remove things from the request.
Envoy is particularly good at HTTP related filtering. It also supports such features as dynamic forward proxy, JWT auth, health checks, and rate limiting.</p>
<p>The functionality is infinitely useful as filters can be such things as gRPC, PostgreSQL, Wasm, and even Lua.</p>

<h4 id="the-implementation">
  The implementation
  <a class = 'heading-anchor' href="#the-implementation">#</a>
</h4>
<p>Once I found the ability to write Lua as a filter, I found that it provided enough capability to perform the dynamic host rewrite.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#062873;font-weight:bold">static_resources</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">listeners</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">address</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">socket_address</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">address</span>:<span style="color:#bbb"> </span><span style="color:#40a070">0.0.0.0</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">port_value</span>:<span style="color:#bbb"> </span><span style="color:#40a070">10000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">filter_chains</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>- <span style="color:#062873;font-weight:bold">filters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>envoy.filters.network.http_connection_manager<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">typed_config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">stat_prefix</span>:<span style="color:#bbb"> </span>ingress_http<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">codec_type</span>:<span style="color:#bbb"> </span>auto<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">route_config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>local_route<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">virtual_hosts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>local_service<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">domains</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- <span style="color:#4070a0">&#34;*&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">routes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span>- <span style="color:#062873;font-weight:bold">match</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                  </span><span style="color:#062873;font-weight:bold">prefix</span>:<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;/&#34;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#062873;font-weight:bold">route</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                  </span><span style="color:#062873;font-weight:bold">cluster</span>:<span style="color:#bbb"> </span>web_service<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">http_filters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>envoy.filters.http.lua<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">typed_config</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">inline_code</span>:<span style="color:#bbb"> </span>|<span style="color:#4070a0;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                local reg1 = &#34;k8s.gcr.io&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                local reg2 = &#34;registry-1.docker.io&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                local reg2WithIP = &#34;192.168.0.1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                function envoy_on_request(request_handle)
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                  local reg = reg1
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                  remoteAddr = request_handle:headers():get(&#34;x-real-ip&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                  if remoteAddr == reg2WithIP then
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                    request_handle:logInfo(&#34;remoteAddr: &#34;..reg2WithIP)
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                    reg = reg2
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                  end
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                  if request_handle:headers():get(&#34;:method&#34;) == &#34;GET&#34; then
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                    request_handle:respond(
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                      {
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                        [&#34;:status&#34;] = &#34;302&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                        [&#34;location&#34;] = &#34;https://&#34;..reg..request_handle:headers():get(&#34;:path&#34;),
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                        [&#34;Content-Type&#34;] = &#34;text/html; charset=utf-8&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                        [&#34;:authority&#34;] = &#34;web_service&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                      },
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                      &#39;&lt;a href=&#34;&#39;..&#34;https://&#34;..reg..request_handle:headers():get(&#34;:path&#34;)..&#39;&#34;&gt;&#39;..&#34;302&#34;..&#34;&lt;/a&gt;.\n&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                  end
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0;font-style:italic">                end</span><span style="color:#bbb">                
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>envoy.filters.http.router<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">typed_config</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">clusters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>web_service<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">connect_timeout</span>:<span style="color:#bbb"> </span><span style="color:#40a070">0.</span>25s<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">type</span>:<span style="color:#bbb"> </span>LOGICAL_DNS<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">lb_policy</span>:<span style="color:#bbb"> </span>round_robin<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">load_assignment</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">cluster_name</span>:<span style="color:#bbb"> </span>web_service<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">endpoints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#062873;font-weight:bold">lb_endpoints</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>- <span style="color:#062873;font-weight:bold">endpoint</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">address</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">socket_address</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#062873;font-weight:bold">address</span>:<span style="color:#bbb"> </span>ii.coop<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#062873;font-weight:bold">port_value</span>:<span style="color:#bbb"> </span><span style="color:#40a070">443</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>With envoy running this config, the behaviour of the requests is</p>
<ul>
<li>rewrite all traffic hitting the web service to <em>k8s.gcr.io</em></li>
<li>except if the IP is <em>192.168.0.1</em> then set the location to <em>registry-1.docker.io</em></li>
</ul>
<p>Since I&rsquo;m using a <a href="https://github.com/sharingio/pair">Pair</a> instance, it sets the local subnet to <em>192.168.0.0/24</em> so when I try to <code>docker pull humacs-envoy-10000.$SHARINGIO_PAIR_BASE_DNS_NAME/library/postgres:12-alpine</code> it will go to <em>docker.io</em>.</p>
<p>On my local machine, pulling container images using <code>docker pull humacs-envoy-10000.$SHARINGIO_PAIR_BASE_DNS_NAME/e2e-test-images/agnhost:2.26</code> will instead use <em>k8s.gcr.io</em>.</p>
<p>To achieve this, I research how other http libraries handle redirects - namely <a href="https://golang.org/src/net/http/server.go?s=66471:66536#L2179">Golang&rsquo;s net/http.Redirect</a>.
The main things that Golang&rsquo;s <em>http.Redirect</em> does is:</p>
<ul>
<li>set the <em>content-type</em> header to <em>text/html</em></li>
<li>set the location to the destination</li>
<li>set the status code to 302</li>
<li>set the body to the same data in earlier steps, but in an <em>a</em> tag.</li>
</ul>

<h3 id="final-thoughts">
  Final thoughts
  <a class = 'heading-anchor' href="#final-thoughts">#</a>
</h3>
<p>I&rsquo;m learning that Envoy is highly flexible and seemly limitless in it&rsquo;s capabilities.</p>
<p>It&rsquo;s exciting to see Envoy being adopted in so many places - moreover to see the diverse usecases and implementations.</p>
<p>Big shout out to <a href="https://ii.coop/author/zach-mandeville">Zach</a> for pairing on this with a few different aspects and attempts! (Zach is cool&#x2122;&#xfe0f;)</p>

    </div>
  </article>
  <nav class="back-nav">
  <a href="/post">← back to posts</a>
  </nav>
</section>

        </main>
        
<footer>
  <div class="footer__left">
  <b class='footer_logo'><a href="/">ii</a></b>
  </div>
  <div class='footer__right'>
  <ul class="contact-details">
 
    <li>   
      <a href="https://github.com/ii">
        <div id="github" class="icon">
            <i class="fab fa-github"></i>
        </div>
        Github
      </a>
    </li>
    <li>
      <a href="https://gitlab.com/ii">
        <div class="icon">
          <i class="fab fa-gitlab"></i>
        </div>
        Gitlab
      </a>
    </li>
    <li>
      <a href="mailto:hello@ii.nz">
        <div class="icon">
          <i class="fas fa-envelope"></i>
      </div>
      Email
      </a>
    </li>
    <li>
      <a href="https://www.linkedin.com/company/99165471/" target="_blank" rel="noopener noreferrer">
        <div class="icon">
          <i class="fab fa-linkedin"></i>
        </div>
        LinkedIn
      </a>
    </li>
    
  </ul>
</footer>
    </body>
</html>