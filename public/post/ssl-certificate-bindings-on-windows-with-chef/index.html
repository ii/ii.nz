<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>ii.nz</title>
   <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Yeseva+One&family=Noto+Sans">
   <link rel="stylesheet" href='/css/normalize.css' type="text/css"/>
   <link rel="stylesheet" href='/css/variables.css' type="text/css"/>
   <link rel="stylesheet" href='/css/main.css' type="text/css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,500&display=swap" rel="stylesheet">
   <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  </style>
</head>
<body>
        <body onload="checkDarkMode()">
    <header>
      <nav class="navbar" role="navigation">
        <div class="navbar__left">
          <a href="/" class="nav-logo">
            <img src="/assets/nav-logo.png" id="navLogo" alt="Logo">
          </a>
        </div>
        <div class="navbar__right" id="navbarRight">
          <li>   
            <div class="icon" onclick="toggleIcon()">
              <i class="fas fa-moon" id="toggleMode"></i>
            </div>
          </li>
          <a href="/team">Team</a>
          <a href="/projects">Projects</a>
          <a href="/post">Blog</a>
          <a href="/contact">Contact</a>
        </div>
      </nav>
    </header>
  
    <script>
      
      function checkDarkMode() {
        var storedMode = localStorage.getItem('darkMode');
        if (storedMode === 'enabled') {
          applyDarkMode();
        }
      }
  
      function toggleIcon() {
        var iconElement = document.getElementById('toggleMode');
     
        
        if (iconElement.classList.contains('fa-moon')) {
          applyDarkMode();
          localStorage.setItem('darkMode', 'enabled');
        } else {
          removeDarkMode();
          localStorage.setItem('darkMode', 'disabled');
        }
      }
  
      
      function applyDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');


        iconElement.classList.remove('fa-moon');
        iconElement.classList.add('fa-sun');
        bg.classList.add('bg-dark');
        header.classList.add('header-dark');
        navbarRight.classList.add("navbar__right--dark");
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = 'white';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.add('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.add('modal-dark');
        }
        logoImage.src = "\/assets\/dark-mode-logo.png";
      }
  
      
      function removeDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');

        
        iconElement.classList.remove('fa-sun');
        iconElement.classList.add('fa-moon');
        bg.classList.remove('bg-dark');
        header.classList.remove('header-dark');
        navbarRight.classList.remove("navbar__right--dark");
        logoImage.src = "\/assets\/nav-logo.png";
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = '';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.remove('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.remove('modal-dark');
        }

      }
    </script>
  </body>
  
        <main id="content">
<section class="post__entry">
  <article>
    <h1 class="post__title">SSL Certificate Bindings on Windows with Chef</h1>
    <div class="post__info">
      <p>By
        
        <span class='post__author'>
          Hippie Hacker
        </span>
        
        ,
        <time>September 6, 2016</time>
      </p>
    </div>
    </div>
    <div class="post__content">
      <p>I recently needed to ensure some ssl certificates on windows installed correctly. I opened an issue at <a href="https://github.com/chef-cookbooks/windows/issues/313">chef-cookbook/windows#313</a> but the gist of it is here:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-feature" data-lang="feature"><span style="display:flex;"><span><span style="color:#06287e">As a windows chef user
</span></span></span><span style="display:flex;"><span><span style="color:#06287e"></span><span style="color:#007020;font-weight:bold">I </span><span style="color:#06287e">want to ensure a specific certificate binding to a port
</span></span></span><span style="display:flex;"><span><span style="color:#06287e">In order to replace any existing binding with what I have specified
</span></span></span><span style="display:flex;"><span><span style="color:#06287e">
</span></span></span><span style="display:flex;"><span><span style="color:#06287e"></span><span style="color:#007020;font-weight:bold">Given </span><span style="color:#06287e">a certificate in pfx form
</span></span></span><span style="display:flex;"><span><span style="color:#06287e"></span><span style="color:#007020;font-weight:bold">And </span><span style="color:#06287e">it&#39;s successfully imported
</span></span></span><span style="display:flex;"><span><span style="color:#06287e"></span><span style="color:#007020;font-weight:bold">When </span><span style="color:#06287e">I write a windows_certificate_binding resource stanza
</span></span></span><span style="display:flex;"><span><span style="color:#06287e"></span><span style="color:#007020;font-weight:bold">And </span><span style="color:#06287e">specify the desired subject or fingerprint
</span></span></span><span style="display:flex;"><span><span style="color:#06287e"></span><span style="color:#007020;font-weight:bold">And </span><span style="color:#06287e">there is already another certificate bound to the desired port
</span></span></span><span style="display:flex;"><span><span style="color:#06287e"></span><span style="color:#007020;font-weight:bold">Then </span><span style="color:#06287e">the desired certificate binding should replace the existing one
</span></span></span></code></pre></div><p>What you currently have to do (using an encrypted data bag with password, subject and fingerpint, and a files/default/certificate.pfx):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>iis_site <span style="color:#4070a0">&#39;Default Web Site&#39;</span> <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>  action <span style="color:#517918">:config</span>
</span></span><span style="display:flex;"><span>  site_id <span style="color:#40a070">1</span>
</span></span><span style="display:flex;"><span>  bindings <span style="color:#4070a0">&#39;http/*:80:,net.tcp/808:*,net.pipe/*,net.msmq/localhost,msmq.formatname/localhost,https/*:443:&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>decrypted <span style="color:#666">=</span> data_bag_item(<span style="color:#4070a0">&#39;passwords&#39;</span>, <span style="color:#4070a0">&#34;certificate&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pfx <span style="color:#666">=</span> <span style="color:#4070a0">&#34;c:</span><span style="color:#4070a0;font-weight:bold">\\</span><span style="color:#4070a0">chef</span><span style="color:#4070a0;font-weight:bold">\\</span><span style="color:#4070a0">certificate.pfx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cookbook_file pfx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>windows_certificate pfx <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>  pfx_password decrypted<span style="color:#666">[</span><span style="color:#4070a0">&#39;password&#39;</span><span style="color:#666">]</span>
</span></span><span style="display:flex;"><span>  store_name <span style="color:#4070a0">&#39;MY&#39;</span>
</span></span><span style="display:flex;"><span>  user_store <span style="color:#007020">false</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>subject <span style="color:#666">=</span> decrypted<span style="color:#666">[</span><span style="color:#4070a0">&#39;subject&#39;</span><span style="color:#666">]</span>
</span></span><span style="display:flex;"><span>fingerprint <span style="color:#666">=</span> decrypted<span style="color:#666">[</span><span style="color:#4070a0">&#39;fingerprint&#39;</span><span style="color:#666">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">#removing the current one IF it doesn&#39;t match</span>
</span></span><span style="display:flex;"><span>windows_certificate_binding <span style="color:#4070a0">&#39;Unbind any non-matching certs&#39;</span> <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>  action <span style="color:#517918">:delete</span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020">name</span> subject
</span></span><span style="display:flex;"><span>  name_kind <span style="color:#517918">:subject</span>
</span></span><span style="display:flex;"><span>  address <span style="color:#4070a0">&#39;0.0.0.0&#39;</span>
</span></span><span style="display:flex;"><span>  guard_interpreter <span style="color:#517918">:powershell_script</span>
</span></span><span style="display:flex;"><span>  not_if <span style="color:#4070a0">&lt;&lt;-EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0"></span>  <span style="color:#60add5">Import</span><span style="color:#666">-</span><span style="color:#60add5">Module</span> <span style="color:#60add5">WebAdministration</span>
</span></span><span style="display:flex;"><span>  $x <span style="color:#666">=</span> <span style="color:#60add5">Git</span><span style="color:#666">-</span><span style="color:#60add5">Item</span> <span style="color:#517918">IIS</span>:\<span style="color:#60add5">SslBindings</span>\<span style="color:#40a070">0</span><span style="color:#666">.</span><span style="color:#40a070">0</span><span style="color:#666">.</span><span style="color:#40a070">0</span><span style="color:#666">.</span><span style="color:#40a070">0</span><span style="color:#666">!</span><span style="color:#40a070">443</span>
</span></span><span style="display:flex;"><span>  $x<span style="color:#666">.</span>Thumbprint<span style="color:#666">.</span>CompareTo(<span style="color:#4070a0">&#34;</span><span style="color:#70a0d0">#{</span>fingerprint<span style="color:#70a0d0">}</span><span style="color:#4070a0">&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#60add5">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"># bind the correct one... this should be all we need to specify...</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"># if there is already a binding on this port... it does nothing</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"># it should replace it in my opinion</span>
</span></span><span style="display:flex;"><span>windows_certificate_binding <span style="color:#4070a0">&#39;Reuse RDP and WINRM self-signed cert for IIS&#39;</span> <span style="color:#007020;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>  action <span style="color:#517918">:create</span>
</span></span><span style="display:flex;"><span>  name_kind <span style="color:#517918">:subject</span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020">name</span> subject
</span></span><span style="display:flex;"><span>  address <span style="color:#4070a0">&#39;0.0.0.0&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">end</span>
</span></span></code></pre></div>
    </div>
  </article>
  <nav class="back-nav">
  <a href="/post">‚Üê back to posts</a>
  </nav>
</section>

        </main>
        
<footer>
  <div class="footer__left">
  <b class='footer_logo'><a href="/">ii</a></b>
  </div>
  <div class='footer__right'>
  <ul class="contact-details">
 
    <li>   
      <a href="https://github.com/ii">
        <div id="github" class="icon">
            <i class="fab fa-github"></i>
        </div>
        Github
      </a>
    </li>
    <li>
      <a href="https://gitlab.com/ii">
        <div class="icon">
          <i class="fab fa-gitlab"></i>
        </div>
        Gitlab
      </a>
    </li>
    <li>
      <a href="mailto:hello@ii.nz">
        <div class="icon">
          <i class="fas fa-envelope"></i>
      </div>
      Email
      </a>
    </li>
    <li>
      <a href="https://www.linkedin.com/company/99165471/" target="_blank" rel="noopener noreferrer">
        <div class="icon">
          <i class="fab fa-linkedin"></i>
        </div>
        LinkedIn
      </a>
    </li>
    
  </ul>
</footer>
    </body>
</html>