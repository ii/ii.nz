<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>ii.nz</title>
   <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Yeseva+One&family=Noto+Sans">
   <link rel="stylesheet" href='/css/normalize.css' type="text/css"/>
   <link rel="stylesheet" href='/css/variables.css' type="text/css"/>
   <link rel="stylesheet" href='/css/main.css' type="text/css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,500&display=swap" rel="stylesheet">
   <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  </style>
</head>
<body>
        <body onload="checkDarkMode()">
    <header>
      <nav class="navbar" role="navigation">
        <div class="navbar__left">
          <a href="/" class="nav-logo">
            <img src="/assets/nav-logo.png" id="navLogo" alt="Logo">
          </a>
        </div>
        <div class="navbar__right" id="navbarRight">
          <li>   
            <div class="icon" onclick="toggleIcon()">
              <i class="fas fa-moon" id="toggleMode"></i>
            </div>
          </li>
          <a href="/team">Team</a>
          <a href="/projects">Projects</a>
          <a href="/post">Blog</a>
          <a href="/contact">Contact</a>
        </div>
      </nav>
    </header>
  
    <script>
      
      function checkDarkMode() {
        var storedMode = localStorage.getItem('darkMode');
        if (storedMode === 'enabled') {
          applyDarkMode();
        }
      }
  
      function toggleIcon() {
        var iconElement = document.getElementById('toggleMode');
     
        
        if (iconElement.classList.contains('fa-moon')) {
          applyDarkMode();
          localStorage.setItem('darkMode', 'enabled');
        } else {
          removeDarkMode();
          localStorage.setItem('darkMode', 'disabled');
        }
      }
  
      
      function applyDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');


        iconElement.classList.remove('fa-moon');
        iconElement.classList.add('fa-sun');
        bg.classList.add('bg-dark');
        header.classList.add('header-dark');
        navbarRight.classList.add("navbar__right--dark");
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = 'white';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.add('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.add('modal-dark');
        }
        logoImage.src = "\/assets\/dark-mode-logo.png";
      }
  
      
      function removeDarkMode() {
        var iconElement = document.getElementById('toggleMode');
        var bg = document.getElementById("content");
        var header = document.getElementsByTagName('header')[0];
        var navbarRight = document.getElementById('navbarRight');
        var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, b, label,li');
        var logoImage = document.getElementById('navLogo')
        var blogPosts = document.getElementsByClassName('post-list__item');
        var modals = document.getElementsByClassName('modal-content');

        
        iconElement.classList.remove('fa-sun');
        iconElement.classList.add('fa-moon');
        bg.classList.remove('bg-dark');
        header.classList.remove('header-dark');
        navbarRight.classList.remove("navbar__right--dark");
        logoImage.src = "\/assets\/nav-logo.png";
  
        for (var i = 0; i < headings.length; i++) {
          headings[i].style.color = '';
        }
        for(var i = 0; i < blogPosts.length; i++){
            blogPosts[i].classList.remove('blog-dark');
        }
        for(var i = 0; i < modals.length; i++){
            modals[i].classList.remove('modal-dark');
        }

      }
    </script>
  </body>
  
        <main id="content">
<section class="post__entry">
  <article>
    <h1 class="post__title">Using cookbook_file per Node on Windows</h1>
    <div class="post__info">
      <p>By
        
        <span class='post__author'>
          Hippie Hacker
        </span>
        
        ,
        <time>September 6, 2016</time>
      </p>
    </div>
    </div>
    <div class="post__content">
      <p>I needed to deploy a different node specific license file to our windows hosts so I wrote a <a href="https://docs.chef.io/resource_cookbook_file.html">cookbook_file</a> resource that looked something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>cookbook_file <span style="color:#4070a0">&#39;C:\\Program Files (x86)\\vendor\\node.license&#39;</span>
</span></span></code></pre></div><p>And using the <a href="https://github.com/chef/chef-rfc/blob/master/rfc017-file-specificity.md">file-specificity overhaul</a> I expected to be able to create a directory for each host under <code>our-cookbook/files/host-NODENAME/our.license</code> and have that be the file for that specific node.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>our-cookbook $ tree files/host-nodes*
</span></span><span style="display:flex;"><span>files/host-nodename1
</span></span><span style="display:flex;"><span>└── node.license
</span></span><span style="display:flex;"><span>files/host-nodename2
</span></span><span style="display:flex;"><span>└── node.license
</span></span><span style="display:flex;"><span>files/host-nodename3
</span></span><span style="display:flex;"><span>└── node.license
</span></span><span style="display:flex;"><span>files/host-nodename4
</span></span><span style="display:flex;"><span>└── node.license
</span></span></code></pre></div><p>It took me a while to understand my failed assumptions.</p>
<p><em>NODENAME isn&rsquo;t the same as FQDN</em></p>
<p>It usually is, but on windows ec2 instances they often differ.</p>
<p>Ec2Config service is configured by default on many windows AMIs to <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/UsingConfig_WinAMI.html#UsingConfigInterface_WinAMI">reset computer name on next boot</a> which results in new machines geting renamed to <code>ip-IP_INHEX</code> where IP_INHEX is the hex representation of the internal ip.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ knife winrm -m $IP &#39;ohai&#39; | grep fqdn
</span></span><span style="display:flex;"><span>10.113.6.171   &#34;fqdn&#34;: &#34;ip-0A7106AB&#34;,
</span></span></code></pre></div><p>When we bootstrap an ec2 ami and give it an ec2 instance name and nodename for chef, the fdqn/hostname is often left as the default:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ knife search node *:$NODE_NAME
</span></span><span style="display:flex;"><span>1 items found
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Node Name:   $NODE_NAME
</span></span><span style="display:flex;"><span>Environment: OURENV
</span></span><span style="display:flex;"><span>FQDN:        ip-0A7106AB
</span></span><span style="display:flex;"><span>IP:          10.113.6.171
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Platform:    windows 6.3.9600
</span></span></code></pre></div><p>The fix for getting our license files into place based on the chef nodename was to add a <code>source</code> parameter to our resource based on the <code>node.name</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>cookbook_file <span style="color:#4070a0">&#39;C:\\Program Files (x86)\\vendor\\node.license&#39;&#39; do
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0">  # normally this is host-#{node[&#39;</span>fdqn<span style="color:#4070a0">&#39;]} and on aws/windows than ip-HEXNUMBR
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0">  source &#34;host-#{node.name}/node.license&#39;</span><span style="color:#4070a0">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0">end
</span></span></span></code></pre></div>
    </div>
  </article>
  <nav class="back-nav">
  <a href="/post">← back to posts</a>
  </nav>
</section>

        </main>
        
<footer>
  <div class="footer__left">
  <b class='footer_logo'><a href="/">ii</a></b>
  </div>
  <div class='footer__right'>
  <ul class="contact-details">
 
    <li>   
      <a href="https://github.com/ii">
        <div id="github" class="icon">
            <i class="fab fa-github"></i>
        </div>
        Github
      </a>
    </li>
    <li>
      <a href="https://gitlab.com/ii">
        <div class="icon">
          <i class="fab fa-gitlab"></i>
        </div>
        Gitlab
      </a>
    </li>
    <li>
      <a href="mailto:hello@ii.nz">
        <div class="icon">
          <i class="fas fa-envelope"></i>
      </div>
      Email
      </a>
    </li>
    <li>
      <a href="https://www.linkedin.com/company/99165471/" target="_blank" rel="noopener noreferrer">
        <div class="icon">
          <i class="fab fa-linkedin"></i>
        </div>
        LinkedIn
      </a>
    </li>
    
  </ul>
</footer>
    </body>
</html>